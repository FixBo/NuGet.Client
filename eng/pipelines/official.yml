parameters:
- name: RunBuildForPublishing
  displayName: Build bits for publishing
  type: boolean
  default: true
- name: RunCrossFrameworkTestsOnWindows
  displayName: Run cross framweork tests on Windows
  type: boolean
  default: true
- name: RunFunctionalTestsOnWindows
  displayName: Run functional tests on Windows
  type: boolean
  default: true
- name: RunSourceBuild
  displayName: Run source build
  type: boolean
  default: true
- name: RunTestsOnLinux
  displayName: Run tests on Linux
  type: boolean
  default: true
- name: RunTestsOnMac
  displayName: Run tests on Mac
  type: boolean
  default: true
- name: RunMonoTestsOnMac
  displayName: Run Mono tests on Mac
  type: boolean
  default: true

resources:
  repositories:
  - repository: MicroBuildTemplate
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate
    ref: refs/tags/release

variables:
  - name: BINLOG_DIRECTORY 
    value: $(Build.StagingDirectory)/binlog
  - name: DOTNET_NOLOGO
    value: 1
  - name: NUGET_EXPERIMENTAL_CHAIN_BUILD_RETRY_POLICY
    value: 3,1000
  - name: Codeql.Enabled
    value: false
  - name: Codeql.TSAEnabled
    value: false
  - name: RunBuildForPublishing
    value: ${{ parameters.RunBuildForPublishing }}
  - name: RunCrossFrameworkTestsOnWindows
    value: ${{ parameters.RunCrossFrameworkTestsOnWindows }}
  - name: RunEndToEndTests
    value: ${{ parameters.RunEndToEndTests }}
  - name: RunFunctionalTestsOnWindows
    value: ${{ parameters.RunFunctionalTestsOnWindows }}
  - name: RunSourceBuild
    value: ${{ parameters.RunSourceBuild }}
  - name: RunTestsOnLinux
    value: ${{ parameters.RunTestsOnLinux }}
  - name
    value: ${{ parameters.RunTestsOnMac }}
  - name: RunMonoTestsOnMac
    value: ${{ parameters.RunMonoTestsOnMac }}

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    sdl:
      sourceAnalysisPool: VSEngSS-MicroBuild2022-1ES
      binskim:
        enabled: true
        scanOutputDirectoryOnly: true
      sbom:
        enabled: false
      credscan:
        enabled: false
    pool:
      name: AzurePipelines-EO
      image: 1ESPT-Windows2022
      os: windows
    customBuildTags:
    - ES365AIMigrationTooling
    stages:
    - template: /eng/pipelines/templates/pipeline.yml@self
      parameters:
        isOfficialBuild: true
        NuGetLocalizationType: Full
        RunBuildForPublishing: ${{parameters.RunBuildForPublishing}}
        RunCrossFrameworkTestsOnWindows: ${{parameters.RunCrossFrameworkTestsOnWindows}}
        RunFunctionalTestsOnWindows: ${{parameters.RunFunctionalTestsOnWindows}}
        RunSourceBuild: ${{parameters.RunSourceBuild}}
        RunTestsOnLinux: ${{parameters.RunTestsOnLinux}}
        RunTestsOnMac: ${{parameters.RunTestsOnMac}}
        RunMonoTestsOnMac: ${{parameters.RunMonoTestsOnMac}}